name: Building OrangeFox recovery

on:
  workflow_dispatch:
    inputs:
      MANIFEST_URL:
        description: 'MANIFEST_URL'
        required: true
        default: 'https://gitlab.com/OrangeFox/Manifest.git'
      MANIFEST_BRANCH:
        description: 'MANIFEST_BRANCH'
        required: true
        default: 'fox_9.0'
      DEVICE_TREE_URL:
        description: 'DEVICE_TREE_URL'
        required: true
        default: 'https://github.com/zaharchenko-test/ofox_lenovo_jd2019.git'
      DEVICE_TREE_BRANCH:
        description: 'DEVICE_TREE_BRANCH'
        required: true
        default: 'fox_9.0'
      DEVICE_PATH:
        description: 'DEVICE_PATH'
        required: true
        default: 'device/lenovo/jd2019'
      DEVICE_NAME:
        description: 'DEVICE_NAME'
        required: true
        default: 'jd2019'
      DEVICE_VARIANT:
        description: 'DEVICE_VARIANT'
        required: true
        default: 'omni'
      MESSAGE:
        description: 'MESSAGE'
        required: true
        default: 'build OrangeFox 9.0'

jobs:
  build:
    runs-on: ubuntu-18.04

    steps:
      - name: Checkout
        uses: actions/checkout@master

      - name: Cleanup
        uses: rokibhasansagar/slimhub_actions@main

      - name: Install OpenJDK
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '8'

      - name: Prepare the environment
        run: |
          sudo apt update
          sudo apt -y upgrade
          sudo apt -y install gperf gcc-multilib gcc-10-multilib g++-multilib g++-10-multilib libc6-dev lib32ncurses5-dev x11proto-core-dev libx11-dev tree lib32z-dev libgl1-mesa-dev libxml2-utils xsltproc bc ccache lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libwxgtk3.0-gtk3-dev libxml2 lzop pngcrush schedtool squashfs-tools imagemagick libbz2-dev lzma ncftp qemu-user-static libstdc++-10-dev python aria2 libncurses5
          sudo apt clean

      - name: Install repo
        run: |
          mkdir ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          sudo ln -sf ~/bin/repo /usr/bin/repo

      - name: Initialize repo
        run: |
          mkdir workspace
          cd workspace
          git config --global user.name "jzinferno"
          git config --global user.email "jekazinferno@gmail.com"
          repo init --depth=1 -q -u ${{ github.event.inputs.MANIFEST_URL }} -b ${{ github.event.inputs.MANIFEST_BRANCH }}

      - name: Repo Sync
        run: |
          cd workspace
          repo sync -c -f -q --force-sync --no-clone-bundle --no-tags -j$(nproc --all)
          rm -rf bootable/recovery/gui/theme
          git clone --depth=1 https://gitlab.com/OrangeFox/misc/theme.git bootable/recovery/gui/theme

      - name: Clone device tree
        run: |
          git clone --depth=1 ${{ github.event.inputs.DEVICE_TREE_URL }} -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} ./workspace/${{ github.event.inputs.DEVICE_PATH }}

      - name: Set Swap Space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 12

      - name: Building recovery
        run: |
          cd workspace
          export PATH=/opt/hostedtoolcache/Java_Zulu_jdk/8.0.345-1/x64/bin:$PATH
          export ALLOW_MISSING_DEPENDENCIES=true
          source build/envsetup.sh
          lunch ${{ github.event.inputs.DEVICE_VARIANT }}_${{ github.event.inputs.DEVICE_NAME }}-eng && mka recoveryimage -j$(nproc --all)

      - name: Release recovery
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.run_id }}
          body: |
            Text: ${{ github.event.inputs.MESSAGE }}
          name: OrangeFox
          files: |
            workspace/out/target/product/jd2019/OrangeFox*.zip
            workspace/out/target/product/jd2019/recovery.img
